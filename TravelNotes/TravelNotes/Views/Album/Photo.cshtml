@model List<TravelNotes.Models.photo>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" >
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
<style>
    #TopS {
        display: flex;
        align-items: center;
        z-index:100;
    }

        #TopS > div {
            display: flex;
            align-items: center;
            z-index: 1000;
        }

    #GuidedTour > a{
        border-radius:10px;
    }

    #GuidedTour > a:hover{
        background-color: whitesmoke;
            transform: scale(1.05);
    }

    #A {
        display:inline-block;
        margin-top:10px;
        justify-content: center;
        align-items: center;
        background-color: white;
        border: 5px solid gray;
        border-radius:20px;
        width: 100%;
        height: auto;
        padding-top:14px;
        text-align:center;
        
    }

    .image-container {
        position: relative;
        display: inline-block;
        padding:2px;
        padding-bottom:4px;

    }

        .image-container:hover {
            transform: scale(1.05);
        }

        .image-container .hover-button {
            position: absolute;
            border: none;
            top: 2px;
            left: 2px;
            width: 40px;
            height: 40px;
            color: white;
            text-align: center;
            line-height: 30px;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
            background-color: rgba(0,0,0,0.3);
        }

        .image-container:hover .hover-button {
            opacity: 1;
        }



    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
    }
    .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
    }
    .close {
        position: absolute;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        top: 35px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 35px;
        z-index:9999
    }
    .close:hover{
            transform: scale(1.2);
    }
    .selected {
        position: relative;
        transform: scale(0.9);
    }


    .check-icon {
        font-size: 24px;
        position: absolute;
        top: 10px;
        right: 14px;
        color: black;
        cursor: pointer;
    }

    
    #uploadBtn{
        border: none;
        font-weight: bold;
        border-radius: 10px;
        font-size:20px;
        background-color: #F3E4C6;
    }
    
    #toggle-select-mode {
        border: none;
        font-weight: bold;
        font-size: 20px;
        border-radius: 10px;
        background-color: #F3E4C6;
    }
   

    #updateNullAlbumPhotos{
        border: none;
        font-weight: bold;
        border-radius: 10px;
        font-size: 20px;
        background-color: #F3E4C6;
    }

    #uploadBtn:hover {
        transform: scale(1.05);
        background-color: whitesmoke;
    }
    #toggle-select-mode:hover {
        transform: scale(1.05);
        background-color: whitesmoke;
    }
    #updateNullAlbumPhotos:hover {
        transform: scale(1.05);
        background-color: whitesmoke;
    }

    .modal-navigation {
        cursor: pointer;
        position: absolute;
        top: 50%;
        display: flex;
        transform: translateY(-50%);
        align-items: center;
        justify-content: center;
        font-size: 2em;
        color: white;
        z-index: 1000;
        user-select: none;
        width: 100%;
        height: 100%;
    }
    .prev {
        left: 0;
        line-height: 70px;
        width:27.25%;
        height:100%;
    }

    .next {
        right:0;
        line-height: 70px;
        width: 27.25%;
        height: 100%;
    }



</style>
<div id="TopS">
    <div >
        <a class="nav-link text-dark" style="font-weight: bold;font-size:20px;" asp-area="" asp-controller="Home" asp-action="Index">TravelNotes</a>
    </div>
    <div id="GuidedTour" style="margin:10px;">
        <a class="nav-link text-dark" asp-area="" asp-controller="Album" asp-action="Photo" asp-route-userId=@ViewBag.UserPage style="background-color:whitesmoke;font-weight: bold;border-radius: 10px;font-size:20px;">我的相片</a>

        <a class="nav-link text-dark" asp-area="" asp-controller="Album" asp-action="Album" asp-route-userId=@ViewBag.UserPage style="font-weight: bold;font-size:20px;">我的相簿</a>
        @if (@ViewBag.IsMyPage == true)
        {
            <a class="nav-link text-dark" asp-area="" asp-controller="Album" asp-action="Garbage" style="font-weight: bold;font-size:20px;">我的垃圾桶</a>
        }
    </div>

    <div style="margin-left:33%;">
        @if (@ViewBag.IsMyPage == true){
            <form asp-action="UploadImages" method="post" enctype="multipart/form-data">
            <input type="file" class="form-control" id="imageFiles" name="imageFiles" accept=".png, .jpg, .jpeg" multiple style="display:none;">
            <button type="button" id="uploadBtn" class="nav-link text-dark"><i class="bi bi-upload"></i>  上傳</button>
            </form>
            <button id="toggle-select-mode" class="nav-link text-dark">
            
                <i class="bi bi-hand-index"></i> 選取 
          
            </button>
            <button id="updateNullAlbumPhotos" class="nav-link text-dark" style="z-index:1000;"><i class="bi bi-trash"></i> 清空相片</button>
        }
    </div>
</div>
<div style="position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 200px; height: 100px; z-index: 1050; display: flex; flex-direction: column; justify-content: center; text-align: center;">
    @if (TempData["Message"] != null)
    {
        <div class="alert alert-warning" role="alert" id="messageAlert">
            @TempData["Message"]
        </div>
    }
    <div id="SuccessMessage" class="alert alert-success" style="display:none;">
        刪除成功！
    </div>
    <div id="FalseMessage" class="alert alert-danger" style="display:none;">
        刪除失敗！
    </div>
    <div id="successMessage" class="alert alert-success" style="display:none;"></div>
    <div id="falseMessage" class="alert alert-danger" style="display:none;"></div>
</div>

    <div id="A">
        @if (Model != null && Model.Any())
        {
            @foreach (photo p in Model)
            {
                <div id="Pho-@p.PhotoId" class="image-container">
                    <img id="dynamicImage-@p.PhotoId" src="@p.PhotoPath" class="image-item" data-photodescription="@p.PhotoDescription" style="width:150px;height:150px;" />
                @if (@ViewBag.IsMyPage == true)
                {
                    <button id="change-image-btn-@p.PhotoId" class="hover-button" data-album-id="@p.AlbumId" data-photo-id="@p.PhotoId" data-upload-date="@p.UploadDate"><i class="bi bi-trash"></i></button>
                }
                <i class="bi bi-check-circle-fill check-icon" style="display:none;" id="CheckCircle-@p.PhotoId"></i>
                </div>
                <div id="myModal" class="modal">
                    <div class="close"><i class="bi bi-x-circle"></i></div>
                    <img class="modal-content" id="Img01">
                    <a class="prev modal-navigation" onclick="changeImage(-1)"><i class="bi bi-arrow-left-circle"></i></a>
                    <a class="next modal-navigation" onclick="changeImage(1)"><i class="bi bi-arrow-right-circle"></i></a>
                </div>
            }
        }
        else
        {
            <h1>目前沒有新增任何相片</h1>
        }
    <div id="popup-div" style="display:none; position: fixed; top: 90%; left: 45%; transform: translate(-50%, -50%); background-color: black; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <i class="bi bi-trash" id="delete-selected-images" style="color: white; display:none;cursor: pointer;"></i>
        <div id="selected-count" style="color: white; display: inline-block; margin-left: 10px;"></div>
    </div>
    </div>
    
    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        var modal = document.getElementById("myModal");
        var modalImg = document.getElementById("Img01");
        var images = document.getElementsByClassName('image-item');
        var currentImageIndex = 0; // 当前显示图片的索引
        let isSelectModeActive = false; // 初始时不在选择模式
        var IsMyPage = @Html.Raw(Json.Serialize(ViewBag.IsMyPage));
        if (IsMyPage == true){
            $('#uploadBtn').click(function () {
                $('#imageFiles').click();
            });
            }
            $('#imageFiles').change(function() {
                if (this.files.length > 0)
                {
            // 如果已选择文件，则提交表单
            $(this.form).submit();
                }
            });
        
        
            
                $('#toggle-select-mode').click(function () {
                    isSelectModeActive = !isSelectModeActive; // 切换选择模式的状态
                });  

        

        // 给所有图片添加点击事件
        for (let i = 0; i < images.length; i++) {
            images[i].onclick = function () {
                if (!isSelectModeActive) { // 只有在非选择模式时才显示 modal
                    showModalImage(i);
                }
            }
        }

        function showModalImage(index) {
            modal.style.display = "block";
            modalImg.src = images[index].src;
            currentImageIndex = index; // 更新当前图片索引
        }

        // 处理上一张和下一张的逻辑
        function changeImage(direction) {
            let newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < images.length) {
                showModalImage(newIndex);
            }
        }


        // 挑選關閉按鈕
        var span = document.getElementsByClassName("close")[0];

        // 點擊關閉按鈕關閉modal
        if (span != null) {
            span.onclick = function () {
                modal.style.display = "none";
            }
        }
        if (modal != null) {
            modal.onclick = function (event) {
                // 檢查點擊是否發生在modal之外
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };
        };
        document.addEventListener('DOMContentLoaded', function () { 
            const toggleSelectModeBtn = document.getElementById('toggle-select-mode');
            const popupDiv = document.getElementById('popup-div');
            const Clean = document.getElementById('updateNullAlbumPhotos');
            let isSelectModeActive = false;
            
                $('#toggle-select-mode').click(function () {
                isSelectModeActive = !isSelectModeActive;
                this.innerHTML = isSelectModeActive ? "<i class='fa-solid fa-ban'></i> 取消" : "<i class='bi bi-hand-index'></i> 選取";
            Clean.style.display = isSelectModeActive ? 'none' : 'block';
            document.querySelectorAll('.hover-button').forEach(function (btn) {
                    btn.style.display = isSelectModeActive ? 'none' : 'block'; 
                });
                
            
                
            

                if (!isSelectModeActive) {
                    document.querySelectorAll('.check-icon').forEach(function (icon) {
                        icon.style.display = 'none';
                        
                    });
                    // 移除所有选中图片的'selected'类
                    document.querySelectorAll('.image-item.selected').forEach(function (image) {
                        image.classList.remove('selected');
                    });
                    // 重置选中图片计数文本
                    updateSelectedCount(true);
                    // 正确设置popupDiv的display属性
                    popupDiv.style.display = 'none';
                    
                } else {
                    // 进入选择模式时更新选中数量
                    updateSelectedCount();
                    // 显示popupDiv
                   popupDiv.style.display = 'block';
                }
                
            });
        

            document.querySelectorAll('.image-item').forEach(image => {
                image.addEventListener('click', function (event) {
                    if (isSelectModeActive) {
                        event.preventDefault();
                        this.classList.toggle('selected');
                        const photoId = this.getAttribute('id').replace('dynamicImage-', '');
                        const checkCircle = document.getElementById(`CheckCircle-${photoId}`);
                        // 判断图片是否被选中，并据此显示或隐藏CheckCircle图标
                        if (this.classList.contains('selected')) {
                            checkCircle.style.display = 'inline-block'; // 显示图标
                        } else {
                            checkCircle.style.display = 'none'; // 隐藏图标
                        }
                        updateSelectedCount(); // 更新选中数量
                }
            });
            });
            function updateSelectedCount() {
                const selectedCount = document.querySelectorAll('.image-item.selected').length;
                
                if (selectedCount > 0) {
                    $('#delete-selected-images').css('display', 'inline-block');
                }
                else {
                    $('#delete-selected-images').css('display', 'none');
                }
                document.getElementById('selected-count').textContent = `已選取${selectedCount}張相片`;
                
            }
            

        });
        $(document).ready(function () { 
            $('#delete-selected-images').click(function () { 
                var selectedImages = document.querySelectorAll('.image-item.selected');
                var photoIds = Array.from(selectedImages).map(image => image.id.split('-')[1]);
                var result = confirm("確定要刪除嗎？");
                if (result) {
                    // 调用更新所有选中图片PhotoDescription的函数
                    updateALLPhotoDescription(photoIds, '1');
                }
            })
        })
        
        $(document).ready(function () {
            // 监听所有删除按钮的点击事件
            $('button[id^="change-image-btn"]').click(function () {
                var result = confirm("確定要刪除嗎？");
                var PhotoId = $(this).data('photo-id');
                // 发送Ajax请求到服务器
                if (result) {
                    $.ajax({
                        url: '/Album/AlbumPhotoToGarbage', // 控制器的Action路径
                        type: 'POST',
                        data: {
                            photoId: PhotoId,
                        },
                        success: function (response) {
                            // 处理成功的响应
                            alert('刪除成功');
                            location.reload();
                        },
                        error: function (xhr, status, error) {
                            // 处理错误的响应
                            alert('刪除失敗');
                            location.reload();
                        }
                    });
                } else {
                    // 如果用户点击“取消”，result 为 false
                    alert("刪除已取消。");
                }
            });
        });
        
        
        function updateALLPhotoDescription(photoIds, newDescription) {
            // 假设服务器端接受一个请求体，其中photoIds是图片ID数组，newDescription是新的描述值
            fetch('/Album/UpdateALLPhotoDescription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'X-CSRF-TOKEN': 'your_csrf_token_here' 如果你的应用使用了CSRF保护，记得添加token
                },
                body: JSON.stringify({
                    photoIds: photoIds,
                    newDescription: newDescription
                })
            })
                .then(response => {
                    if (response.ok) {
                        // 存储一个标志位在localStorage表示成功
                        localStorage.setItem("photoUpdateStatus", "success");
                    } else {
                        // 存储一个标志位在localStorage表示失败
                        localStorage.setItem("photoUpdateStatus", "fail");
                    }
                    // 重新加载页面
                    window.location.reload();
                })
                .catch((error) => {
                    console.error('Error:', error);
                    localStorage.setItem("photoUpdateStatus", "fail");
                    window.location.reload();
                });
        }
        document.addEventListener('DOMContentLoaded', function () {
            // 检查localStorage中的状态
            const status = localStorage.getItem("photoUpdateStatus");

            if (status === "success") {
                document.getElementById("SuccessMessage").style.display = "block";
                setTimeout(() => {
                    document.getElementById("SuccessMessage").style.display = "none";
                }, 3000); // 3秒后隐藏
            } else if (status === "fail") {
                document.getElementById("FalseMessage").style.display = "block";
                setTimeout(() => {
                    document.getElementById("FalseMessage").style.display = "none";
                }, 3000); // 3秒后隐藏
            }

            // 清除状态以避免重新加载页面时再次显示消息
            localStorage.removeItem("photoUpdateStatus");
        });

        $("#updateNullAlbumPhotos").click(function () {
            var result = confirm("確定要刪除嗎？");
            if (result) {
                $.ajax({
                    url: '/Album/UpdateNullAlbumPhotosToMinAlbumId', // 更新为你的实际URL路径
                    type: 'POST',
                    success: function (response) {
                        // 这里可以添加一些成功操作的反馈，例如提示用户
                        localStorage.setItem('deleteSuccessMessage', '刪除成功');
                        location.reload();
                    },
                    error: function () {
                        // 这里是处理错误的反馈
                        localStorage.setItem('deleteFalseMessage', '刪除失敗');
                        location.reload();
                    }
                });
            }
        });

        $(document).ready(function () {
            // SET一個定時器
            setTimeout(function () {
                //使用 jQuery 的 fadeOut 方法淡出
                $("#messageAlert").fadeOut("slow");
            }, 3000); // 3 秒
        });
        $(document).ready(function () {
            // 檢查localStorage中是否有删除成功的消息
            var deleteSuccessMessage = localStorage.getItem('deleteSuccessMessage');
            if (deleteSuccessMessage) {
                // 顯示成功
                $('#successMessage').text(deleteSuccessMessage).show();

                // 設置3秒後消失
                setTimeout(function () {
                    $('#successMessage').fadeOut('slow');
                }, 3000);

                // 清除消息，避免下次加載頁面時再次顯示
                localStorage.removeItem('deleteSuccessMessage');
            }
        });

        $(document).ready(function () {
            // 檢查localStorage中是否有删除成功的消息
            var deleteFalseMessage = localStorage.getItem('deleteFalseMessage');
            if (deleteFalseMessage) {
                // 顯示失敗
                $('#falseMessage').text(deleteFalseMessage).show();

                // 設置3秒後消失
                setTimeout(function () {
                    $('#falseMessage').fadeOut('slow');
                }, 3000);

                // 清除消息，避免下次加載頁面時再次顯示
                localStorage.removeItem('deleteFalseMessage');
            }
        });
    </script>